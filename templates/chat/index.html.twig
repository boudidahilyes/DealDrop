{% extends 'baseFrontOffice.html.twig' %}
{% block body %}
	<main id="main-content" class="grow lg:pt-0">
		<div class="pt-10 pb-16 lg:pt-20 lg:pb-44">
			<div class="container">
				<div class="grid grid-cols-12 gap-x-5 md:gap-x-6 lg:gap-x-7.5">
					<div class="col-span-full lg:col-span-8 lg:pr-[70px]">
						<div class="mt-16 md:mt-20 lg:mt-28 xl:mt-32">
							<h2 class="mb-8 text-xl font-bold text-gray-900 dark:text-white md:mb-16 md:text-2xl lg:mb-20 lg:text-3xl xl:mb-24 xl:text-4xl">
								Chat</h2>
							<ol id='chatbox'>
								{% if messages != null %}
									{% for message in messages %}
										<li class="mb-12 lg:mb-20">
											<div>
												<div
													class="flex gap-x-5 md:gap-x-7 mb-7">
													{# 										<figure class="shrink-0"><img src="/build/images/str1/samples/user-2-60x60.jpg" alt="Comment Author Avatar"></figure> #}
													<div class="flex-grow">
														<div>
															<h5 class="mb-1 text-lg md:text-xl lg:text-2xl font-bold text-gray-900 dark:text-white">{{message.sender.firstName}}
																{{message.sender.lastName}}</h5>
														</div>
													</div>
												</div>
												<div class="mb-7 leading-relaxed md:text-lg md:leading-9">{{message.content}}</div>
											</div>
										</li>
									</li>
								{% endfor %}
							{% endif %}
						</ol>

					</div>

					<div class="mt-16 md:mt-20 lg:mt-28 xl:mt-32">
						<div class="col-span-full">
							<textarea class="block border-base bg-white/40 w-full px-4 py-2 tracking-tight text-gray-900 transition-all duration-150 placeholder:text-gray-500/60 focus:border-accent focus:outline-0 focus:ring-0 dark:border-gray-650 dark:bg-gray-900/40 dark:text-white dark:placeholder:text-gray-500/80 dark:focus:border-accent dark:focus:bg-gray-900 h-40 md:h-48" name="post-comment" id="message" placeholder="" style="height: 94px;"></textarea>
						</div>
						<div class="col-span-full lg:flex lg:justify-end">
							<button type="submit" id="sendit" class="inline-flex text-center font-bold leading-none transition-colors uppercase justify-center gap-x-3 py-4 px-4 md:py-[18px] lg:px-8 text-sm text-gray-900 bg-accent hover:bg-accent/90 w-full lg:w-auto lg:basis-1/3">Send</button>
						</div>
					</div>

				</div>
				<div class="col-span-full lg:col-span-4 self-start">
					<div class="mb-8 lg:mb-12">

						<div class="font-medium">
							<div>
								<label class="block text-sm font-bold uppercase text-gray-500 [&:not(:empty)]:mb-2.5" for="priceForPoster">Negotiated Price</label>
								{% if app.user == chat.offer.productPosted.member %}
									<input class="group-[.is-success]:bg-input-success-dark group-[.is-error]:border-danger group-[.is-error]:bg-input-invalid group-[.is-error]:text-danger group-[.is-success]:pr-16 group-[.is-invalid]:pr-16 px-4 py-2 border-base bg-white/40 bg-[length:18px_18px,_38px_38px] bg-[position:right_16px_center,_right_6px_center] bg-no-repeat font-medium leading-8 tracking-tight text-gray-900 transition-all duration-150 placeholder:font-normal placeholder:text-gray-500/60 focus:border-accent focus:bg-white focus:text-gray-900 focus:outline-0 focus:ring-0 dark:border-gray-650 dark:group-[.is-success]:bg-input-success dark:bg-gray-900/40 dark:text-white dark:placeholder:text-gray-500/80 dark:focus:border-accent dark:focus:bg-gray-900 w-full" type="number" name="priceForPoster" id="priceForPoster" value="0" readonly>
								{% else %}
									<input class="group-[.is-success]:bg-input-success-dark group-[.is-error]:border-danger group-[.is-error]:bg-input-invalid group-[.is-error]:text-danger group-[.is-success]:pr-16 group-[.is-invalid]:pr-16 px-4 py-2 border-base bg-white/40 bg-[length:18px_18px,_38px_38px] bg-[position:right_16px_center,_right_6px_center] bg-no-repeat font-medium leading-8 tracking-tight text-gray-900 transition-all duration-150 placeholder:font-normal placeholder:text-gray-500/60 focus:border-accent focus:bg-white focus:text-gray-900 focus:outline-0 focus:ring-0 dark:border-gray-650 dark:group-[.is-success]:bg-input-success dark:bg-gray-900/40 dark:text-white dark:placeholder:text-gray-500/80 dark:focus:border-accent dark:focus:bg-gray-900 w-full" type="number" name="priceForOfferer" id="priceForOfferer">
								{% endif %}
							</div>
						</div>
					</div>
					{% if app.user == chat.offer.productPosted.member %}
					<form id="myForm" action="/your-action" method="POST">
							<!-- Your form fields here -->
							<button type="submit" id="submitButton" class="inline-flex text-center font-bold leading-none transition-colors uppercase justify-center gap-x-3 py-4 px-4 md:py-[18px] lg:px-8 text-sm text-gray-900 bg-accent hover:bg-accent/90 w-full">Accept Price</button>
					</form>
					{% else %}
							<!-- Your form fields here -->
							<button type="submit" id="placePrice" class="inline-flex text-center font-bold leading-none transition-colors uppercase justify-center gap-x-3 py-4 px-4 md:py-[18px] lg:px-8 text-sm text-gray-900 bg-accent hover:bg-accent/90 w-full">Place Price!</button>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
</main>{% endblock %}{% block endbodyjs %}
<script>

	const webSocket = new WebSocket("ws://127.0.0.4:8800");
const myname ='{{ app.user.firstName }}' + '   {{ app.user.lastName }}';
const hisname = {% if app.user == chat.offer.productPosted.member %}'{{ chat.offer.productOffered.member.firstName }}' + '   {{ chat.offer.productOffered.member.lastName }}'
{% else %}
'{{ chat.offer.productPosted.member.firstName }}' + '   {{ chat.offer.productPosted.member.lastName }}'{% endif %};
const receiver = {% if app.user == chat.offer.productPosted.member %}
{{ chat.offer.productOffered.member.id }}
{% else %}
{{ chat.offer.productPosted.member.id }}
{% endif %};
const sender = {% if app.user == chat.offer.productPosted.member %}
{{ chat.offer.productPosted.member.id }}
{% else %}
{{ chat.offer.productOffered.member.id }}
{% endif %};
webSocket.onopen = function (event) {
webSocket.send(JSON.stringify({'type': 'open', 'id': {{ app.user.id }}}))
console.log("WebSocket connection opened");
};


// Send the message to the WebSocket server
document.getElementById("sendit").addEventListener("click", function () {
let mess = document.getElementById("message");
webSocket.send(JSON.stringify({
'type': 'send',
'id': receiver,
'message': mess.value,
'idChat': {{ chat.id }},
'idSender': sender
}))
const html = '<li class="mb-12 lg:mb-20"><div><div class="flex gap-x-5 md:gap-x-7 mb-7"><div class="flex-grow"><div><h5 class="mb-1 text-lg md:text-xl lg:text-2xl font-bold text-gray-900 dark:text-white">' + myname + '</h5></div></div></div><div class="mb-7 leading-relaxed md:text-lg md:leading-9">' + mess.value + '</div></div></li></li>';
document.getElementById('chatbox').insertAdjacentHTML('beforeend', html);
mess.value = '';
})

webSocket.onmessage = function (data) {
const html = '<li class="mb-12 lg:mb-20"><div><div class="flex gap-x-5 md:gap-x-7 mb-7"><div class="flex-grow"><div><h5 class="mb-1 text-lg md:text-xl lg:text-2xl font-bold text-gray-900 dark:text-white">' + hisname + '</h5></div></div></div><div class="mb-7 leading-relaxed md:text-lg md:leading-9">' + data.data + '</div></div></li></li>';
console.log(data);
document.getElementById('chatbox').insertAdjacentHTML('beforeend', html);
}
{# if(document.getElementById("placePrice") !=null){
document.getElementById("placePrice").addEventListener("click", function () {
let price = document.getElementById("priceForOfferer");
webSocket.send(JSON.stringify({
'type': 'sendPrice',
'id': receiver,
'price': price.value
}))
});
}
webSocket.onmessage = function (data) {
document.getElementById('priceForPoster').value = data.data;
console.log(data);
} #}
// Clear the input field

webSocket.onerror = function (event) {
console.error("WebSocket error:", event);
};

webSocket.onclose = function (event) {
console.log("WebSocket connection closed");
};
</script>{% endblock %}
